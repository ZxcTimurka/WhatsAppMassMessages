# WhatsApp Mass Messenger (с интеграцией Google Sheets)

Простое веб-приложение на Flask для массовой отправки сообщений WhatsApp с использованием внешнего API (например, Green-API). Приложение читает номера телефонов из указанного диапазона в Google Sheet, отправляет им сообщения и записывает подробный отчет о статусе отправки обратно в новый лист этой же Google Таблицы.

## Возможности

*   Чтение номеров телефонов из Google Sheets (указанный лист и диапазон).
*   Автоматическое форматирование номеров (поддерживает форматы `8-xxx`, `+7xxx`, `7xxx`, `xxx` для российских номеров, приводя их к `7xxxxxxxxxx`).
*   Отправка сообщений через настраиваемый WhatsApp API эндпоинт.
*   Простой веб-интерфейс для запуска рассылки, настройки текста сообщения и задержки.
*   Генерация подробного отчета в новом листе Google Таблицы (имя листа = дата и время запуска) для каждой рассылки:
    *   № п/п
    *   Номер телефона (Number)
    *   Имя (Name - пока не используется)
    *   Статус (Status: Отправлено / Не отправлено)
    *   Время отправки (Time: ЧЧ:ММ:СС)
*   Функция "Проверить доступ" для предварительной верификации подключения к Google Sheets и прав доступа.
*   Использование переменных окружения для конфигурации (через `.env` файл).

## Предварительные требования

*   **Python 3.x**: Убедитесь, что Python установлен.
*   **pip**: Менеджер пакетов Python (обычно идет с Python).
*   **Google Cloud Project**:
    *   Проект в [Google Cloud Console](https://console.cloud.google.com/).
    *   Включенный **Google Sheets API**.
*   **Google Service Account**:
    *   Сервисный аккаунт, созданный в вашем Google Cloud проекте.
    *   Скачанный JSON-файл с ключом для этого сервисного аккаунта.
        *   Чтобы скачать JSON-файл: IAM & Admin -> Service Accounts -> Create Service Account -> Настройте аккаунт -> Нажмите на адрес аккаунта -> Keys -> Add Key -> Create New Key -> JSON
*   **Google Sheet**:
    *   Таблица Google, в одном из столбцов которой перечислены номера телефонов для рассылки.
    *   **ВАЖНО:** Предоставлен доступ к этой таблице для email-адреса вашего сервисного аккаунта с правами **Редактора (Editor)**. Права Читателя (Viewer) будет недостаточно для создания отчетов.
*   **WhatsApp API Провайдер**:
    *   Аккаунт у провайдера WhatsApp API (в нашем случае Green-API).
    *   URL или Токен для доступа к API отправки сообщений.
*   **Git** (опционально, для клонирования репозитория).

## Установка

1.  **Клонировать репозиторий** (или скачать и распаковать архив):
    ```bash
    git clone https://github.com/ZxcTimurka/WhatsAppMassMessages.git
    cd WhatsAppMassMessages
    ```

2.  **Создать и активировать виртуальное окружение** (рекомендуется):
    *   Windows:
        ```bash
        python -m venv venv
        .\venv\Scripts\activate
        ```

3.  **Установить зависимости**:
    ```bash
    pip install -r requirements.txt
    ```

4.  **Разместить ключ сервисного аккаунта**:
    *   Переименуйте скачанный JSON-файл ключа в `service_account.json`.
    *   Поместите файл `service_account.json` в корневую папку проекта (`WhatsAppMassMessages/`).

## Конфигурация

1.  **Изменить файл `.env.example` на `.env`**:

2.  **Отредактировать файл `.env`**, заполнив его вашими реальными данными:
    *   `TOKEN`: **Полный URL** вашего API для отправки сообщений, включая токен (например, `https://api.green-api.com/waInstanceXXXXXXXXXX/SendMessage/YYYYYYYYYYYYYYYYYYYYYYYY`). Убедитесь, что это именно тот URL, который ожидает ваш `requests.post`.
    *   `SPREADSHEET_ID`: ID вашей Google Таблицы. Его можно найти в URL таблицы (между `/d/` и `/edit`).
    *   `SERVICE_ACCOUNT_FILE`: Должно остаться `'service_account.json'`, если вы поместили файл в корень проекта.
    *   `RANGE_NAME`: Имя листа и диапазон столбца с номерами телефонов. Например, `'Лист1!A2:A'` (Номера в столбце A, начиная со второй строки, на листе "Лист1").

## Запуск Приложения

1.  Убедитесь, что ваше виртуальное окружение активировано.
    ```bash
    .\venv\Scripts\activate
    ```
3.  Запустите Flask-приложение:
    ```bash
    python app.py
    ```
4.  Приложение сообщит, по какому адресу оно доступно. Обычно это `http://127.0.0.1:5000/` или `http://0.0.0.0:5000/` (последний означает, что доступно с других устройств в вашей сети).

## Использование

1.  Откройте URL приложения (например, `http://127.0.0.1:5000/`) в вашем веб-браузере.
2.  **(Рекомендуется)** Нажмите кнопку **"Проверить доступ к Google Sheet"**. Убедитесь, что проверка прошла успешно как для чтения, так и для записи (статус "Права на запись... есть"). Если есть ошибки (особенно 403 Forbidden или сообщение об отсутствии прав редактора), проверьте права доступа к таблице для вашего сервисного аккаунта.
3.  Введите **текст сообщения**, которое вы хотите отправить.
4.  Установите желаемую **задержку** между отправкой сообщений (в секундах). Рекомендуется установить небольшую задержку (например, 1-5 секунд), чтобы избежать блокировки со стороны WhatsApp или API провайдера.
5.  Нажмите кнопку **"Начать рассылку"**.
6.  Приложение начнет процесс: чтение номеров, форматирование, отправку сообщений и создание листа отчета (если возможно).
7.  На странице результатов вы увидите подробные **логи** процесса, итоговую статистику (успешно/неуспешно) и статус создания отчета в Google Sheets.
8.  Проверьте вашу Google Таблицу – там должен появиться новый лист с именем вида `ДД.ММ.ГГ ЧЧ:ММ:СС`, содержащий детальный отчет.

## Возможные проблемы (Troubleshooting)

*   **Ошибка `Unable to find the server at oauth2.googleapis.com`:** Проблема с сетью или DNS. Проверьте интернет-соединение, `ping oauth2.googleapis.com`, настройки DNS, файрвола или прокси на машине, где запущено приложение.
*   **Ошибки Google API `403 Forbidden`:** Сервисный аккаунт не имеет необходимых прав (нужны права **Редактора**) для доступа к таблице или для выполнения операции (например, создания листа). Перепроверьте настройки доступа к Google Sheet.
*   **Ошибки Google API `404 Not Found`:** Неправильный `SPREADSHEET_ID` указан в `.env`.
*   **Ошибки отправки сообщений (от API провайдера):** Проверьте правильность `TOKEN` (URL/ключа) в `.env`, статус вашего аккаунта у API провайдера, не нарушает ли текст сообщения правила WhatsApp, не превышены ли лимиты отправки. Изучите ответ API, показанный в логах.
*   **Ошибка `FileNotFoundError: [Errno 2] No such file or directory: 'service_account.json'`:** Файл `service_account.json` не найден в корне проекта, или значение `SERVICE_ACCOUNT_FILE` в `.env` указано неверно.
